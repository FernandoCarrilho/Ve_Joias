<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout | Vejoias</title>
    <!-- Carregamento do Tailwind CSS para estilo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configuração da fonte Inter -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        /* Estilização para o indicador de progresso */
        .step-active { @apply bg-pink-600 text-white; }
        .step-done { @apply bg-green-500 text-white; }
        .step-done i { @apply fas fa-check; }
    </style>
    <!-- Ícones Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Header (Simplificado para o Checkout) -->
    <header class="bg-white shadow-lg sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <a href="./home.html" class="text-3xl font-extrabold text-pink-600 tracking-wider">Vejoias Checkout</a>
            <div id="user-status" class="flex items-center space-x-3 text-sm font-medium">
                <span id="user-info"></span>
                <a href="./cart.html" class="text-pink-600 hover:text-pink-800 transition"><i class="fas fa-shopping-cart"></i> Carrinho</a>
            </div>
        </div>
    </header>

    <main class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-12 min-h-[80vh]">

        <h1 class="text-3xl font-extrabold text-gray-900 mb-8 text-center">Finalizar Pedido</h1>
        
        <!-- Indicador de Progresso (Passos) -->
        <div class="flex justify-between items-center mb-10 bg-white p-4 rounded-xl shadow-md">
            <div id="step-review" class="flex-1 text-center">
                <div class="w-8 h-8 mx-auto rounded-full flex items-center justify-center text-sm font-bold bg-pink-600 text-white mb-1"><i class="fas fa-eye"></i></div>
                <span class="text-xs sm:text-sm">Revisão</span>
            </div>
            <div class="flex-1 border-t-2 border-gray-300 mx-2 sm:mx-4"></div>
            <div id="step-shipping" class="flex-1 text-center">
                <div class="w-8 h-8 mx-auto rounded-full flex items-center justify-center text-sm font-bold bg-gray-200 text-gray-600 mb-1">2</div>
                <span class="text-xs sm:text-sm">Envio</span>
            </div>
            <div class="flex-1 border-t-2 border-gray-300 mx-2 sm:mx-4"></div>
            <div id="step-payment" class="flex-1 text-center">
                <div class="w-8 h-8 mx-auto rounded-full flex items-center justify-center text-sm font-bold bg-gray-200 text-gray-600 mb-1">3</div>
                <span class="text-xs sm:text-sm">Pagamento</span>
            </div>
            <div class="flex-1 border-t-2 border-gray-300 mx-2 sm:mx-4"></div>
            <div id="step-confirmation" class="flex-1 text-center">
                <div class="w-8 h-8 mx-auto rounded-full flex items-center justify-center text-sm font-bold bg-gray-200 text-gray-600 mb-1">4</div>
                <span class="text-xs sm:text-sm">Confirmação</span>
            </div>
        </div>

        <!-- Conteúdo do Checkout (Baseado no Passo Atual) -->
        <div id="checkout-content" class="bg-white p-8 rounded-xl shadow-lg">
            
            <!-- Mensagens de Estado Inicial -->
            <div id="initial-state-messages">
                <p id="loading-message" class="text-center text-gray-500 py-10">
                    <i class="fas fa-spinner fa-spin mr-2"></i> Carregando carrinho e autenticação...
                </p>
                <p id="auth-required-message" class="text-center text-red-500 py-10 hidden">
                    <i class="fas fa-user-lock text-3xl mb-3"></i><br>
                    Você precisa estar logado para finalizar a compra. <a href="./auth.html" class="text-pink-600 font-bold hover:underline">Faça login aqui.</a>
                </p>
                <p id="empty-cart-message" class="text-center text-gray-500 py-10 hidden">
                    <i class="fas fa-box-open text-3xl mb-3"></i><br>
                    Seu carrinho está vazio. <a href="./shop.html" class="text-pink-600 font-bold hover:underline">Adicione produtos para continuar.</a>
                </p>
            </div>
            
            <!-- Passos do Checkout (Ocultos inicialmente) -->
            <div id="review-step" class="hidden">
                <h2 class="text-2xl font-bold mb-4 border-b pb-2">1. Revisão do Pedido</h2>
                <div id="review-items-list" class="space-y-4 mb-6 max-h-96 overflow-y-auto">
                    <!-- Itens do Carrinho serão injetados aqui -->
                </div>
                <div class="text-right text-xl font-bold">
                    Total a Pagar: <span id="review-total" class="text-pink-600">R$ 0,00</span>
                </div>
                <button id="next-to-shipping" class="w-full mt-6 py-3 bg-pink-600 text-white font-bold rounded-lg hover:bg-pink-700 transition">
                    <i class="fas fa-truck mr-2"></i> Continuar para Envio
                </button>
            </div>

            <div id="shipping-step" class="hidden">
                <h2 class="text-2xl font-bold mb-4 border-b pb-2">2. Informações de Envio</h2>
                <form id="shipping-form" class="space-y-4">
                    <input type="text" id="ship-name" placeholder="Nome Completo" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500">
                    <input type="email" id="ship-email" placeholder="Email (Para Notificações)" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500">
                    <input type="text" id="ship-address" placeholder="Endereço Completo (Rua, Número, Bairro)" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500">
                    <input type="text" id="ship-city" placeholder="Cidade / Estado" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500">
                    <input type="text" id="ship-zip" placeholder="CEP" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500">
                    <div class="flex justify-between space-x-4">
                        <button type="button" id="back-to-review" class="w-1/2 py-3 bg-gray-200 text-gray-700 font-bold rounded-lg hover:bg-gray-300 transition"><i class="fas fa-arrow-left mr-2"></i> Voltar</button>
                        <button type="submit" id="next-to-payment" class="w-1/2 py-3 bg-pink-600 text-white font-bold rounded-lg hover:bg-pink-700 transition"><i class="fas fa-money-bill-wave mr-2"></i> Continuar para Pagamento</button>
                    </div>
                </form>
            </div>

            <div id="payment-step" class="hidden text-center">
                <h2 class="text-2xl font-bold mb-6 border-b pb-2">3. Simulação de Pagamento</h2>
                <p class="text-gray-600 mb-8">Esta é uma simulação de pagamento seguro. O valor total é de <span id="payment-total" class="font-bold text-pink-600">R$ 0,00</span>.</p>
                
                <div id="payment-card" class="max-w-sm mx-auto bg-pink-100 p-6 rounded-xl shadow-inner border border-pink-300">
                    <div class="flex justify-center items-center text-pink-700 mb-4">
                        <i class="fas fa-credit-card text-4xl mr-3"></i>
                        <span class="text-2xl font-bold">Cartão de Crédito Falso</span>
                    </div>
                    <p class="text-sm text-gray-600">Aperte o botão abaixo para simular a aprovação do pagamento.</p>
                </div>
                
                <button id="process-order-btn" class="w-full mt-8 py-3 bg-green-600 text-white text-lg font-bold rounded-lg hover:bg-green-700 transition disabled:bg-gray-400 disabled:cursor-not-allowed">
                    <i class="fas fa-check-circle mr-2"></i> Processar Pagamento e Finalizar
                </button>
                <button type="button" id="back-to-shipping" class="w-full mt-4 py-3 bg-gray-200 text-gray-700 font-bold rounded-lg hover:bg-gray-300 transition"><i class="fas fa-arrow-left mr-2"></i> Voltar</button>

                <p id="processing-message" class="text-blue-500 mt-4 hidden"><i class="fas fa-circle-notch fa-spin mr-2"></i> Processando seu pedido...</p>
                <p id="processing-error" class="text-red-500 mt-4 hidden font-semibold"></p>
            </div>

            <div id="confirmation-step" class="hidden text-center py-10">
                <i class="fas fa-gem text-6xl text-pink-600 mb-4 animate-bounce"></i>
                <h2 class="text-3xl font-extrabold text-green-700 mb-3">Pedido Realizado com Sucesso!</h2>
                <p class="text-lg text-gray-600 mb-6">Seu pedido <span id="order-id-display" class="font-mono bg-gray-100 p-1 rounded">#...</span> foi processado e está sendo preparado para envio.</p>
                <p class="text-md text-gray-500 mb-8">Obrigado por comprar na Vejoias!</p>
                <a href="./home.html" class="inline-block py-3 px-8 bg-pink-600 text-white font-bold rounded-lg hover:bg-pink-700 transition"><i class="fas fa-home mr-2"></i> Voltar para a Home</a>
            </div>

        </div>

    </main>

    <!-- Modal de Mensagem Temporária (Substitui alert) -->
    <div id="temp-message-div" class="fixed top-4 right-4 z-50 p-4 rounded-lg shadow-xl text-white transform translate-y-[-100px] transition-transform duration-300 hidden"></div>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white mt-12 py-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <p class="text-pink-400 font-semibold mb-2">Vejoias &copy; 2024</p>
            <div class="flex justify-center space-x-6 text-gray-400">
                <a href="./home.html" class="hover:text-white transition">Home</a>
                <a href="./shop.html" class="hover:text-white transition">Loja</a>
                <a href="./cart.html" class="hover:text-white transition">Carrinho</a>
                <a href="./admin.html" class="hover:text-white transition">Admin</a>
            </div>
        </div>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, onSnapshot, setLogLevel, doc, setDoc, runTransaction, collection, updateDoc 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('Debug');

        // Variáveis globais obrigatórias
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const ADMIN_UID = 'default-admin-uid';
        
        // Inicialização do Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let currentUserId = null;
        let cartData = null; // Armazena o conteúdo do carrinho
        let currentStep = 'review'; // review, shipping, payment, confirmation

        // --- Referências DOM ---
        const initialMessagesDiv = document.getElementById('initial-state-messages');
        const loadingMessage = document.getElementById('loading-message');
        const authRequiredMessage = document.getElementById('auth-required-message');
        const emptyCartMessage = document.getElementById('empty-cart-message');
        const reviewList = document.getElementById('review-items-list');
        const reviewTotalSpan = document.getElementById('review-total');
        const paymentTotalSpan = document.getElementById('payment-total');
        const orderIdDisplay = document.getElementById('order-id-display');
        const processingMessage = document.getElementById('processing-message');
        const processingError = document.getElementById('processing-error');
        const userInfoSpan = document.getElementById('user-info');
        
        // Botões e Formulários
        const nextToShippingBtn = document.getElementById('next-to-shipping');
        const backToReviewBtn = document.getElementById('back-to-review');
        const backToShippingBtn = document.getElementById('back-to-shipping');
        const shippingForm = document.getElementById('shipping-form');
        const processOrderBtn = document.getElementById('process-order-btn');

        // Inputs de Envio
        const shipNameInput = document.getElementById('ship-name');
        const shipEmailInput = document.getElementById('ship-email');
        let shippingDetails = {}; // Armazena detalhes de envio

        // --- Funções Auxiliares ---
        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        }
        
        /**
         * Retorna a referência do carrinho do usuário.
         */
        function getCartDocRef(userId) {
            return doc(db, `artifacts/${appId}/users/${userId}/cart/current`);
        }
        
        /**
         * Retorna a referência da coleção de pedidos do usuário.
         */
        function getOrdersCollectionRef(userId) {
            // Pedidos são privados e associados ao usuário que comprou
            return collection(db, `artifacts/${appId}/users/${userId}/orders`);
        }
        
        /**
         * Retorna a referência do produto no Admin para atualização de estoque.
         */
        function getProductDocRef(productId) {
            return doc(db, `artifacts/${appId}/users/${ADMIN_UID}/products/${productId}`);
        }

        /**
         * Atualiza o visual do progresso e do passo atual.
         */
        function updateStepUI() {
            const steps = ['review', 'shipping', 'payment', 'confirmation'];
            
            steps.forEach((stepName, index) => {
                const stepElement = document.getElementById(`step-${stepName}`);
                const contentElement = document.getElementById(`${stepName}-step`);
                
                // Oculta/Exibe o conteúdo
                if (stepName === currentStep) {
                    contentElement.classList.remove('hidden');
                } else {
                    contentElement.classList.add('hidden');
                }

                // Atualiza o indicador de passo
                stepElement.querySelector('div').classList.remove('step-active', 'step-done', 'bg-gray-200', 'text-gray-600');
                
                if (index < steps.indexOf(currentStep)) {
                    stepElement.querySelector('div').classList.add('step-done');
                    stepElement.querySelector('div').innerHTML = '<i class="fas fa-check"></i>';
                } else if (stepName === currentStep) {
                    stepElement.querySelector('div').classList.add('step-active');
                    if (stepName !== 'review' && stepName !== 'confirmation') {
                        stepElement.querySelector('div').innerHTML = index + 1;
                    }
                } else {
                    stepElement.querySelector('div').classList.add('bg-gray-200', 'text-gray-600');
                    stepElement.querySelector('div').innerHTML = index + 1;
                }
            });
        }
        
        /**
         * Navega para um novo passo.
         */
        function goToStep(newStep) {
            currentStep = newStep;
            updateStepUI();
        }

        /**
         * Renderiza o conteúdo do carrinho no passo de revisão.
         */
        function renderReviewStep(data) {
            initialMessagesDiv.classList.add('hidden');
            cartData = data;
            const items = Object.values(data.items || {});
            let subtotal = 0;

            reviewList.innerHTML = '';
            
            if (items.length === 0) {
                // Caso o carrinho esvazie durante o checkout
                emptyCartMessage.classList.remove('hidden');
                goToStep('review'); 
                return;
            }

            items.forEach(item => {
                const itemTotal = item.price * item.quantity;
                subtotal += itemTotal;
                
                reviewList.innerHTML += `
                    <div class="flex items-center justify-between p-3 border-b border-gray-100 last:border-b-0">
                        <div class="flex items-center">
                            <img src="${item.imageUrl}" alt="${item.name}" class="w-10 h-10 object-cover rounded mr-3">
                            <p class="font-medium text-gray-800">${item.name}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-gray-500">${item.quantity} x ${formatCurrency(item.price)}</p>
                            <p class="font-bold text-pink-600">${formatCurrency(itemTotal)}</p>
                        </div>
                    </div>
                `;
            });

            // Atualiza os totais
            reviewTotalSpan.textContent = formatCurrency(subtotal);
            paymentTotalSpan.textContent = formatCurrency(subtotal);
            
            goToStep('review'); // Garante que estamos no passo correto
        }

        // --- Lógica Transacional de Finalização ---

        /**
         * Executa a transação de pedido: 
         * 1. Confirma o estoque
         * 2. Atualiza o estoque no Admin
         * 3. Cria o Pedido (Order)
         * 4. Limpa o carrinho do usuário
         */
        async function finalizeOrderTransaction() {
            if (!currentUserId || !cartData || Object.keys(cartData.items).length === 0) {
                throw new Error("Dados do usuário ou carrinho inválidos.");
            }
            
            const items = Object.values(cartData.items);
            let totalAmount = items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            try {
                // RUN TRANSACTION: Garante que as operações são atômicas
                const orderId = await runTransaction(db, async (transaction) => {
                    const orderDate = new Date().toISOString();
                    const newOrderId = `PAG-${Date.now()}`; // ID Simples para exibição

                    // 1. Verificar e Atualizar Estoque (Produto por Produto)
                    for (const item of items) {
                        const productRef = getProductDocRef(item.id);
                        const productSnap = await transaction.get(productRef);

                        if (!productSnap.exists()) {
                            throw new Error(`Produto ${item.name} não encontrado no estoque.`);
                        }

                        const currentStock = productSnap.data().stock;
                        if (currentStock < item.quantity) {
                            throw new Error(`Estoque insuficiente para ${item.name}. Apenas ${currentStock} restante(s).`);
                        }
                        
                        // Reduz o estoque na transação
                        const newStock = currentStock - item.quantity;
                        transaction.update(productRef, { stock: newStock });
                    }
                    
                    // 2. Criar o Documento do Pedido (Permanente)
                    const orderRef = doc(getOrdersCollectionRef(currentUserId), newOrderId);
                    const orderDetails = {
                        id: newOrderId,
                        userId: currentUserId,
                        items: items, // Array de itens comprados
                        total: totalAmount,
                        shipping: shippingDetails,
                        status: 'processing',
                        date: orderDate
                    };
                    transaction.set(orderRef, orderDetails);

                    // 3. Limpar o Carrinho (Temporário)
                    const cartRef = getCartDocRef(currentUserId);
                    // Definir o documento do carrinho para um estado vazio
                    transaction.set(cartRef, { items: {}, lastUpdated: orderDate });

                    return newOrderId; // Retorna o ID do pedido
                });

                // Transação bem-sucedida
                processingMessage.classList.add('hidden');
                orderIdDisplay.textContent = `#${orderId}`;
                goToStep('confirmation'); // Passa para o passo de sucesso
                
            } catch (e) {
                // Transação falhou (rollback automático)
                console.error("Erro na transação de pedido:", e);
                processingMessage.classList.add('hidden');
                processingError.textContent = `Erro ao finalizar: ${e.message}. Tente novamente.`;
                processingError.classList.remove('hidden');
                processOrderBtn.disabled = false;
                processOrderBtn.innerHTML = '<i class="fas fa-check-circle mr-2"></i> Processar Pagamento e Finalizar';
            }
        }


        // --- Listeners de Eventos ---

        nextToShippingBtn.addEventListener('click', () => {
            if (cartData && Object.keys(cartData.items).length > 0) {
                // Preenche o formulário com dados conhecidos (email)
                if(shipEmailInput.value === '') {
                    shipEmailInput.value = auth.currentUser?.email || '';
                }
                goToStep('shipping');
            }
        });

        backToReviewBtn.addEventListener('click', () => {
            goToStep('review');
        });

        backToShippingBtn.addEventListener('click', () => {
            goToStep('shipping');
        });

        shippingForm.addEventListener('submit', (e) => {
            e.preventDefault();
            // Salva os detalhes de envio
            shippingDetails = {
                name: shipNameInput.value,
                email: shipEmailInput.value,
                address: document.getElementById('ship-address').value,
                city: document.getElementById('ship-city').value,
                zip: document.getElementById('ship-zip').value,
            };
            goToStep('payment');
        });

        processOrderBtn.addEventListener('click', async () => {
            processOrderBtn.disabled = true;
            processOrderBtn.innerHTML = '<i class="fas fa-circle-notch fa-spin mr-2"></i> Processando...';
            processingMessage.classList.remove('hidden');
            processingError.classList.add('hidden');
            
            await finalizeOrderTransaction();
        });


        // --- Inicialização ---

        window.onload = function() {
            // Tenta autenticar via token customizado ou anônimo
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                signInWithCustomToken(auth, __initial_auth_token).catch(e => {
                    console.error('Erro na autenticação com token customizado, caindo para anônimo:', e);
                    signInAnonymously(auth); 
                });
            } else {
                 signInAnonymously(auth).catch(e => {
                     console.error("Falha ao tentar login anônimo", e);
                 });
            }

            onAuthStateChanged(auth, (user) => {
                loadingMessage.classList.add('hidden');
                if (user && !user.isAnonymous) {
                    currentUserId = user.uid;
                    userInfoSpan.textContent = `Logado: ${user.email || 'Usuário ' + user.uid.substring(0, 4) + '...'}`;
                    
                    // Inicia o listener do carrinho
                    onSnapshot(getCartDocRef(currentUserId), (docSnapshot) => {
                        const data = docSnapshot.exists() ? docSnapshot.data() : { items: {} };
                        const itemsCount = Object.keys(data.items || {}).length;

                        if (itemsCount > 0) {
                            renderReviewStep(data);
                        } else if (currentStep !== 'confirmation') {
                            // Se o carrinho esvaziou (e não estamos na tela de sucesso)
                            initialMessagesDiv.classList.remove('hidden');
                            emptyCartMessage.classList.remove('hidden');
                            document.querySelectorAll('#checkout-content > div').forEach(el => el.classList.add('hidden'));
                        }
                    }, (error) => {
                        console.error("Erro no listener do carrinho:", error);
                        processingError.textContent = 'Erro ao carregar o carrinho.';
                        processingError.classList.remove('hidden');
                    });

                } else {
                    // Usuário anônimo ou deslogado
                    initialMessagesDiv.classList.remove('hidden');
                    authRequiredMessage.classList.remove('hidden');
                    document.querySelectorAll('#checkout-content > div').forEach(el => el.classList.add('hidden'));
                }
            });

            updateStepUI(); // Renderiza o estado inicial
        }
    </script>
</body>
</html>

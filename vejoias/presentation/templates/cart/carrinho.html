{% extends "base.html" %}

{% block title %}Seu Carrinho de Compras{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-5xl">
    <h1 class="text-4xl font-extrabold mb-8 text-gray-800 border-b pb-2">
        <i class="fas fa-shopping-cart text-pink-500 mr-2"></i> Seu Carrinho
    </h1>

    {% if carrinho and carrinho.itens %}
        <div class="lg:flex lg:space-x-8">
            
            <!-- Detalhes dos Itens do Carrinho -->
            <div class="lg:w-2/3 space-y-6" id="cart-items-container">
                {% for item in carrinho.itens %}
                <div id="item-{{ item.joia.id }}" class="flex items-center bg-white p-4 rounded-xl shadow-lg transition duration-300 hover:shadow-xl">
                    
                    <!-- Imagem e Detalhes -->
                    <div class="w-20 h-20 bg-gray-100 rounded-lg mr-4 flex-shrink-0">
                        <img src="{{ item.joia.imagem_url|default:'https://placehold.co/80x80/2f4f4f/ffffff?text=JA' }}" 
                            alt="{{ item.joia.nome }}" 
                            class="w-full h-full object-cover rounded-lg" 
                            onerror="this.onerror=null;this.src='https://placehold.co/80x80/cccccc/333333?text=Joia'" />
                    </div>

                    <div class="flex-grow">
                        <h2 class="text-lg font-semibold text-gray-900">
                            <a href="{% url 'detalhe_joia' item.joia.id %}" class="hover:text-pink-600">{{ item.joia.nome }}</a>
                        </h2>
                        <p class="text-gray-600">
                            R$ {{ item.joia.preco|floatformat:2 }}
                        </p>
                        
                        <!-- Controles de Quantidade -->
                        <div class="flex items-center mt-2 space-x-2">
                            <button onclick="atualizarQuantidade('{{ item.joia.id }}', {{ item.quantidade|add:'-1' }})"
                                    class="text-gray-500 hover:text-pink-600 {% if item.quantidade <= 1 %}opacity-50 cursor-not-allowed{% endif %}"
                                    {% if item.quantidade <= 1 %}disabled{% endif %}>
                                <i class="fas fa-minus-circle"></i>
                            </button>
                            <span class="font-semibold text-gray-700">{{ item.quantidade }}</span>
                            <button onclick="atualizarQuantidade('{{ item.joia.id }}', {{ item.quantidade|add:'1' }})"
                                    class="text-gray-500 hover:text-pink-600">
                                <i class="fas fa-plus-circle"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Preço Subtotal e Botão Remover -->
                    <div class="flex flex-col items-end space-y-2">
                        <span class="text-xl font-bold text-pink-600">
                            R$ {{ item.subtotal|floatformat:2 }}
                        </span>
                        <button 
                            onclick="removerItem('{{ item.joia.id }}')"
                            class="text-red-500 hover:text-red-700 p-1 rounded-full transition duration-150"
                            aria-label="Remover {{ item.joia.nome }}">
                            <i class="fas fa-times-circle text-lg"></i>
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Resumo do Carrinho e Checkout -->
            <div class="lg:w-1/3 mt-8 lg:mt-0">
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 sticky top-4">
                    <h2 class="text-2xl font-bold mb-4 text-gray-800">Resumo do Pedido</h2>
                    
                    <div class="space-y-3 mb-6">
                        <div class="flex justify-between text-gray-600">
                            <span>Itens ({{ carrinho.total_itens }}):</span>
                            <span id="subtotal">R$ {{ carrinho.subtotal|floatformat:2 }}</span>
                        </div>
                        <div class="flex justify-between text-gray-600 border-t pt-3">
                            <span>Frete:</span>
                            <span class="font-semibold text-green-600">Grátis</span>
                        </div>
                    </div>

                    <div class="flex justify-between text-2xl font-bold text-gray-900 border-t pt-4">
                        <span>Total:</span>
                        <span id="total">R$ {{ carrinho.subtotal|floatformat:2 }}</span>
                    </div>

                    <a href="{% url 'processar_checkout' %}" id="checkout-link"
                       class="mt-6 w-full flex justify-center items-center px-6 py-3 border border-transparent text-lg font-medium rounded-xl shadow-md text-white bg-pink-600 hover:bg-pink-700 transition duration-300 transform hover:scale-[1.01] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-pink-500">
                        Finalizar Compra
                    </a>

                    <a href="{% url 'lista_joias' %}" class="mt-4 block text-center text-sm text-pink-600 hover:text-pink-800">
                        <i class="fas fa-arrow-left mr-1"></i> Continuar Comprando
                    </a>
                </div>
            </div>
        </div>

    {% else %}
        <!-- Carrinho Vazio -->
        <div class="text-center bg-white p-12 rounded-xl shadow-lg">
            <i class="fas fa-box-open text-6xl text-gray-400 mb-4"></i>
            <p class="text-2xl font-semibold mb-2">Seu carrinho está vazio.</p>
            <p class="text-gray-500 mb-6">Adicione joias deslumbrantes para começar a comprar!</p>
            <a href="{% url 'lista_joias' %}" 
               class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-lg shadow-sm text-white bg-pink-600 hover:bg-pink-700 transition duration-300">
                Ver Catálogo
            </a>
        </div>
    {% endif %}
</div>

<!-- Mensagem de Notificação -->
<div id="notification" class="fixed top-4 right-4 transform translate-y-[-100%] opacity-0 transition-all duration-300 z-50"></div>

{% block extra_js %}
<script>
    // Função para mostrar notificações
    function showNotification(message, type = 'success') {
        const notification = document.getElementById('notification');
        const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
        
        notification.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-[-100%] opacity-0 transition-all duration-300 z-50`;
        notification.textContent = message;
        
        // Mostrar
        setTimeout(() => {
            notification.style.transform = 'translateY(0)';
            notification.style.opacity = '1';
        }, 100);
        
        // Esconder
        setTimeout(() => {
            notification.style.transform = 'translateY(-100%)';
            notification.style.opacity = '0';
        }, 3000);
    }

    // Token CSRF do Django
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    // Função para atualizar a quantidade de um item
    function atualizarQuantidade(joiaId, novaQuantidade) {
        if (novaQuantidade < 1) return;

        fetch("{% url 'api_carrinho' %}", {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({
                joia_id: joiaId,
                quantidade: novaQuantidade
            })
        })
        .then(response => {
            if (!response.ok) throw new Error('Falha ao atualizar quantidade');
            return response.json();
        })
        .then(data => {
            // Atualiza a UI com os novos valores
            const itemElement = document.getElementById(`item-${joiaId}`);
            if (itemElement) {
                const quantidadeSpan = itemElement.querySelector('.quantidade');
                const subtotalSpan = itemElement.querySelector('.subtotal');
                if (quantidadeSpan) quantidadeSpan.textContent = novaQuantidade;
                if (subtotalSpan) subtotalSpan.textContent = `R$ ${data.subtotal.toFixed(2)}`;
            }
            
            // Atualiza o resumo do carrinho
            document.getElementById('subtotal').textContent = `R$ ${data.carrinho_total.toFixed(2)}`;
            document.getElementById('total').textContent = `R$ ${data.carrinho_total.toFixed(2)}`;
            
            showNotification('Quantidade atualizada com sucesso!');
        })
        .catch(error => {
            console.error('Erro:', error);
            showNotification('Erro ao atualizar quantidade', 'error');
        });
    }

    // Função para remover um item do carrinho
    function removerItem(joiaId) {
        if (!confirm('Tem certeza de que deseja remover este item do carrinho?')) {
            return;
        }

        fetch("{% url 'api_carrinho' %}", {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({ joia_id: joiaId })
        })
        .then(response => {
            if (!response.ok) throw new Error('Falha ao remover item');
            return response.json();
        })
        .then(data => {
            // Remove o elemento do item
            const itemElement = document.getElementById(`item-${joiaId}`);
            if (itemElement) {
                itemElement.remove();
            }
            
            // Atualiza o resumo do carrinho
            if (data.carrinho_vazio) {
                // Recarrega a página se o carrinho estiver vazio
                window.location.reload();
            } else {
                document.getElementById('subtotal').textContent = `R$ ${data.carrinho_total.toFixed(2)}`;
                document.getElementById('total').textContent = `R$ ${data.carrinho_total.toFixed(2)}`;
            }
            
            showNotification('Item removido com sucesso!');
        })
        .catch(error => {
            console.error('Erro:', error);
            showNotification('Erro ao remover item', 'error');
        });
    }
</script>
{% endblock %}
{% endblock %}
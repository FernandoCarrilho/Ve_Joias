<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Detalhes do Produto | Vejóias</title>
    <!-- Carregamento do Tailwind CSS para estilo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configuração da fonte Inter -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
    </style>
    <!-- Ícones Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Header Principal -->
    <header class="bg-white shadow-md sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <a href="./home.html" class="text-3xl font-extrabold text-pink-600 tracking-wider">
                Vejóias
            </a>
            <nav class="space-x-4 flex items-center">
                <a href="./home.html" class="text-gray-600 hover:text-pink-600 transition duration-150">Início</a>
                <a href="#" class="text-gray-600 hover:text-pink-600 transition duration-150">Coleções</a>
                <a href="./admin/products_list.html" class="text-gray-600 hover:text-pink-600 transition duration-150">Admin</a>
                <a href="./auth.html" class="text-gray-600 hover:text-pink-600 transition duration-150">Login</a>
                <a href="./cart.html" class="relative p-2 rounded-full text-gray-600 hover:text-pink-600 transition duration-150">
                    <i class="fas fa-shopping-cart text-lg"></i>
                    <span id="cart-count-header" class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-white transform translate-x-1/2 -translate-y-1/2 bg-pink-500 rounded-full hidden">0</span>
                </a>
            </nav>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8 min-h-[70vh]">

        <!-- Estado de Carregamento -->
        <div id="loading-state" class="text-center py-20">
            <i class="fas fa-spinner fa-spin text-4xl text-pink-500 mb-3"></i>
            <p class="text-gray-600">Buscando detalhes da jóia...</p>
        </div>

        <!-- Conteúdo Principal do Produto (Escondido até o carregamento) -->
        <section id="product-section" class="flex flex-col lg:flex-row gap-8 bg-white p-6 md:p-10 rounded-2xl shadow-xl hidden">
            
            <!-- Imagem do Produto -->
            <div class="lg:w-1/2">
                <div class="aspect-square bg-gray-100 rounded-xl overflow-hidden shadow-lg border border-gray-200">
                    <img id="product-image" src="" alt="Imagem do Produto" class="w-full h-full object-cover"
                         onerror="this.onerror=null;this.src='https://placehold.co/800x800/FFB6C1/FFFFFF?text=Joia';">
                </div>
            </div>

            <!-- Detalhes e Ações -->
            <div class="lg:w-1/2">
                <p id="product-category" class="text-sm font-semibold text-pink-500 uppercase tracking-widest mb-2"></p>
                <h1 id="product-name" class="text-4xl font-extrabold text-gray-800 mb-4"></h1>
                
                <p id="product-price" class="text-5xl font-bold text-pink-600 mb-6"></p>
                
                <div class="mb-8 border-t border-b py-6">
                    <h2 class="text-xl font-semibold text-gray-700 mb-3">Descrição</h2>
                    <p id="product-description" class="text-gray-600 leading-relaxed whitespace-pre-wrap"></p>
                </div>
                
                <!-- Status e Estoque -->
                <div class="mb-6 flex items-center space-x-4">
                    <span id="stock-status" class="py-1 px-3 rounded-full text-sm font-semibold"></span>
                    <span id="product-stock" class="text-gray-500 text-sm"></span>
                </div>

                <!-- Formulário de Ação -->
                <div class="flex items-center space-x-4">
                    
                    <!-- Seletor de Quantidade -->
                    <div class="flex items-center border border-gray-300 rounded-lg p-1">
                        <button id="decrement-qty" class="p-2 text-gray-600 hover:bg-gray-100 rounded-l transition duration-150">
                            <i class="fas fa-minus"></i>
                        </button>
                        <input type="number" id="product-quantity" value="1" min="1" max="99" 
                               class="w-16 text-center border-none focus:ring-0 focus:outline-none text-xl font-medium text-gray-700">
                        <button id="increment-qty" class="p-2 text-gray-600 hover:bg-gray-100 rounded-r transition duration-150">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>

                    <!-- Botão Adicionar ao Carrinho -->
                    <button id="add-to-cart-btn" class="flex-grow py-3 px-6 bg-pink-600 text-white font-bold rounded-xl shadow-lg hover:bg-pink-700 transition duration-300 transform hover:scale-[1.01] flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fas fa-cart-plus mr-2"></i> Adicionar ao Carrinho
                    </button>
                </div>
            </div>
        </section>

        <!-- Mensagem de erro/Produto não encontrado -->
        <div id="error-state" class="text-center py-20 hidden">
            <i class="fas fa-exclamation-triangle text-6xl text-red-400 mb-6"></i>
            <h2 class="text-2xl font-semibold text-gray-500 mb-2" id="error-title">Produto Não Encontrado</h2>
            <p class="text-gray-400 mb-6" id="error-message">Não foi possível carregar os detalhes do produto. Verifique o link.</p>
            <a href="./home.html" class="inline-flex items-center py-3 px-6 bg-pink-600 text-white font-bold rounded-full shadow-xl hover:bg-pink-700 transition duration-300">
                <i class="fas fa-arrow-left mr-2"></i> Voltar à Loja
            </a>
        </div>
        
        <!-- Mensagem de status (Modal customizado) -->
        <div id="status-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden" onclick="closeModal()">
            <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm mx-4 transform transition-all duration-300" onclick="event.stopPropagation()">
                <h3 id="modal-title" class="text-xl font-bold mb-3"></h3>
                <p id="modal-message" class="text-gray-700 mb-4"></p>
                <div class="flex justify-end space-x-3">
                    <button onclick="closeModal()" class="py-2 px-4 bg-gray-200 text-gray-800 font-bold rounded-lg hover:bg-gray-300 transition">Continuar Comprando</button>
                    <a href="./cart.html" class="py-2 px-4 bg-pink-600 text-white font-bold rounded-lg hover:bg-pink-700 transition">Ir para o Carrinho</a>
                </div>
            </div>
        </div>

    </main>
    
    <!-- Footer Simples -->
    <footer class="bg-gray-800 text-white mt-12 py-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <p class="text-pink-400 font-semibold mb-2">Vejóias &copy; 2024</p>
            <p class="text-sm text-gray-400">Joias que refletem sua essência.</p>
        </div>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('Debug');

        // Variáveis globais obrigatórias
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        // Inicialização do Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        const ADMIN_USER_ID = 'default-admin-uid';
        let currentProductData = null; // Armazena os dados do produto carregado
        let currentProductId = null; // Armazena o ID do produto

        // --- Referências DOM ---
        const loadingState = document.getElementById('loading-state');
        const productSection = document.getElementById('product-section');
        const errorState = document.getElementById('error-state');
        
        // Detalhes do produto
        const productImage = document.getElementById('product-image');
        const productCategory = document.getElementById('product-category');
        const productName = document.getElementById('product-name');
        const productPrice = document.getElementById('product-price');
        const productDescription = document.getElementById('product-description');
        const stockStatus = document.getElementById('stock-status');
        const productStock = document.getElementById('product-stock');
        
        // Controles de Carrinho
        const productQuantityInput = document.getElementById('product-quantity');
        const decrementQtyBtn = document.getElementById('decrement-qty');
        const incrementQtyBtn = document.getElementById('increment-qty');
        const addToCartBtn = document.getElementById('add-to-cart-btn');
        const cartCountHeader = document.getElementById('cart-count-header');
        
        // Modal
        const statusModal = document.getElementById('status-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');

        /**
         * Retorna a referência da coleção de produtos do Admin.
         */
        function getProductDocRef(productId) {
            // Os produtos ativos estão na coleção privada do Admin.
            return doc(db, `artifacts/${appId}/users/${ADMIN_USER_ID}/products`, productId);
        }

        /**
         * Exibe o modal de status.
         * @param {string} title
         * @param {string} message
         * @param {string} type - 'success' ou 'error'
         */
        window.showModal = function(title, message, type = 'success') {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            
            // Adiciona um pouco de estilo ao título
            modalTitle.className = 'text-xl font-bold mb-3 ' + (type === 'success' ? 'text-green-600' : 'text-red-600');

            statusModal.classList.remove('hidden');
        }

        /**
         * Fecha o modal de status.
         */
        window.closeModal = function() {
            statusModal.classList.add('hidden');
        }

        /**
         * Obtém o ID do produto da URL.
         * @returns {string|null} ID do produto ou null.
         */
        function getProductIdFromUrl() {
            const params = new URLSearchParams(window.location.search);
            return params.get('id');
        }

        /**
         * Renderiza a página com base nos dados do produto.
         * @param {Object} product - Dados do produto.
         */
        function renderProduct(product) {
            currentProductData = product;
            
            document.getElementById('page-title').textContent = `${product.name} | Vejoias`;
            
            productImage.src = product.imageUrl;
            productCategory.textContent = product.category || 'Sem Categoria';
            productName.textContent = product.name;
            productPrice.textContent = `R$ ${product.price.toFixed(2).replace('.', ',')}`;
            productDescription.textContent = product.description;
            productQuantityInput.max = product.stock;

            // Lógica de Estoque
            const isInStock = product.stock > 0;
            const stockText = isInStock ? `${product.stock} em estoque` : 'Esgotado';
            
            stockStatus.textContent = isInStock ? 'Em Estoque' : 'Esgotado';
            stockStatus.className = `py-1 px-3 rounded-full text-sm font-semibold ${isInStock ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`;
            productStock.textContent = stockText;
            
            // Desabilita botões se estiver fora de estoque
            addToCartBtn.disabled = !isInStock;
            productQuantityInput.disabled = !isInStock;
            decrementQtyBtn.disabled = !isInStock;
            incrementQtyBtn.disabled = !isInStock;

            // Se estiver em estoque, garanta que a quantidade inicial seja 1
            if (isInStock) {
                productQuantityInput.value = 1;
            }

            loadingState.classList.add('hidden');
            productSection.classList.remove('hidden');
        }

        /**
         * Exibe o estado de erro.
         * @param {string} title
         * @param {string} message
         */
        function displayError(title, message) {
            loadingState.classList.add('hidden');
            productSection.classList.add('hidden');
            document.getElementById('error-title').textContent = title;
            document.getElementById('error-message').textContent = message;
            errorState.classList.remove('hidden');
        }

        /**
         * Busca os detalhes do produto no Firestore.
         */
        async function fetchProductDetails() {
            currentProductId = getProductIdFromUrl();
            if (!currentProductId) {
                return displayError("ID Ausente", "O ID do produto não foi fornecido na URL.");
            }

            try {
                const productDoc = await getDoc(getProductDocRef(currentProductId));

                if (productDoc.exists() && productDoc.data().status === 'active') {
                    renderProduct(productDoc.data());
                } else {
                    displayError("Produto Não Encontrado", "O produto não existe ou não está ativo na loja.");
                }
            } catch (error) {
                console.error("Erro ao buscar produto:", error);
                displayError("Erro de Conexão", "Não foi possível carregar o produto. Verifique sua conexão ou tente novamente.");
            }
        }
        
        // --- Lógica do Carrinho (Adaptação da Lógica de cart.html) ---

        /**
         * Obtém o carrinho do localStorage.
         * @returns {Array<Object>} Lista de itens no carrinho.
         */
        function getCart() {
            try {
                const cartString = localStorage.getItem('vejoias_cart') || '[]';
                return JSON.parse(cartString);
            } catch (error) {
                console.error("Erro ao carregar carrinho do localStorage:", error);
                return [];
            }
        }

        /**
         * Salva o carrinho no localStorage.
         * @param {Array<Object>} cart - Lista de itens.
         */
        function saveCart(cart) {
            try {
                localStorage.setItem('vejoias_cart', JSON.stringify(cart));
                updateCartCountHeader(cart);
            } catch (error) {
                console.error("Erro ao salvar carrinho no localStorage:", error);
                // Não precisa de modal aqui, apenas log para não interromper o fluxo
            }
        }
        
        /**
         * Atualiza o contador de itens no cabeçalho.
         */
        function updateCartCountHeader(cart) {
            const cartItems = cart || getCart();
            const totalItems = cartItems.reduce((sum, item) => sum + item.quantity, 0);
            
            cartCountHeader.textContent = totalItems;
            if (totalItems > 0) {
                cartCountHeader.classList.remove('hidden');
            } else {
                cartCountHeader.classList.add('hidden');
            }
        }

        /**
         * Adiciona o produto atual ao carrinho.
         * @param {number} quantity - Quantidade a adicionar.
         */
        function addToCart(quantity) {
            if (!currentProductData || !currentProductId) return;

            let cart = getCart();
            const existingItemIndex = cart.findIndex(item => item.id === currentProductId);
            
            let newQuantity = quantity;

            if (existingItemIndex > -1) {
                // Item já existe, atualiza a quantidade
                newQuantity = cart[existingItemIndex].quantity + quantity;
            }

            // Checagem de estoque antes de adicionar/atualizar
            if (newQuantity > currentProductData.stock) {
                showModal("Limite de Estoque", `Você só pode adicionar mais ${currentProductData.stock - (existingItemIndex > -1 ? cart[existingItemIndex].quantity : 0)} unidades deste produto. O estoque total é de ${currentProductData.stock}.`, 'error');
                return;
            }
            
            if (existingItemIndex > -1) {
                cart[existingItemIndex].quantity = newQuantity;
            } else {
                // Novo item no carrinho
                const cartItem = {
                    id: currentProductId,
                    productData: {
                        name: currentProductData.name,
                        price: currentProductData.price,
                        imageUrl: currentProductData.imageUrl,
                        // Outros dados essenciais podem ser adicionados aqui
                    },
                    quantity: quantity
                };
                cart.push(cartItem);
            }

            saveCart(cart);
            showModal("Adicionado ao Carrinho!", `${quantity}x ${currentProductData.name} adicionado(s) com sucesso.`, 'success');
        }

        // --- Event Listeners ---

        // Controle de Quantidade (Incremento/Decremento)
        decrementQtyBtn.addEventListener('click', () => {
            let current = parseInt(productQuantityInput.value);
            if (current > 1) {
                productQuantityInput.value = current - 1;
            }
        });

        incrementQtyBtn.addEventListener('click', () => {
            let current = parseInt(productQuantityInput.value);
            let maxStock = parseInt(productQuantityInput.max);
            
            if (current < maxStock) {
                productQuantityInput.value = current + 1;
            }
        });
        
        // Controle de Quantidade (Input direto)
        productQuantityInput.addEventListener('change', (e) => {
            let value = parseInt(e.target.value);
            const maxStock = parseInt(productQuantityInput.max);
            
            if (isNaN(value) || value < 1) {
                value = 1;
            } else if (value > maxStock) {
                value = maxStock;
                showModal("Aviso de Estoque", `Você só pode adicionar um máximo de ${maxStock} unidades.`, 'error');
            }
            e.target.value = value;
        });

        // Botão Adicionar ao Carrinho
        addToCartBtn.addEventListener('click', () => {
            const quantity = parseInt(productQuantityInput.value);
            if (quantity > 0) {
                addToCart(quantity);
            } else {
                showModal("Aviso", "A quantidade deve ser de pelo menos 1.", 'error');
            }
        });

        /**
         * Autentica o usuário anonimamente e inicia a busca.
         */
        async function initializeAuthAndFetch() {
            try {
                // O cliente acessa anonimamente para ler os dados públicos/Admin
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                
                // Carrega o produto
                fetchProductDetails();
                
                // Atualiza o contador de carrinho
                updateCartCountHeader();

            } catch (error) {
                console.error('Erro na autenticação Firebase:', error);
                displayError("Erro de Inicialização", "Falha na conexão com o serviço de autenticação.");
            }
        }

        // --- Inicialização ---
        initializeAuthAndFetch();
        
    </script>
</body>
</html>

{% extends "vejoias/presentation/templates/base.html" %}

{% block title %}Gestão de Cupons{% endblock %}

{% block content %}
<div class="p-6 md:p-10">
    <!-- Título e Ação Principal -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8">
        <h1 class="text-3xl font-bold text-gray-800 flex items-center">
            <i class="fas fa-tag text-pink-500 mr-3"></i> 
            Gestão de Cupons de Desconto
        </h1>
        <button id="open-modal-button" class="mt-4 sm:mt-0 px-6 py-2 bg-pink-600 text-white font-semibold rounded-xl shadow-md hover:bg-pink-700 transition duration-150 transform hover:scale-105">
            <i class="fas fa-plus mr-2"></i> Adicionar Novo Cupom
        </button>
    </div>

    <!-- Filtros e Busca -->
    <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            
            <!-- Busca por Código -->
            <div>
                <label for="search-code" class="block text-sm font-medium text-gray-700 mb-1">Buscar por Código</label>
                <input type="text" id="search-code" placeholder="Ex: VERAO20" 
                       class="w-full border-gray-300 rounded-lg shadow-sm focus:border-pink-500 focus:ring-pink-500">
            </div>

            <!-- Filtro por Status -->
            <div>
                <label for="filter-status" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                <select id="filter-status" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-pink-500 focus:ring-pink-500">
                    <option value="">Todos</option>
                    <option value="active">Ativo</option>
                    <option value="inactive">Inativo</option>
                    <option value="expired">Expirado</option>
                </select>
            </div>
            
            <!-- Filtro por Tipo -->
            <div>
                <label for="filter-type" class="block text-sm font-medium text-gray-700 mb-1">Tipo de Desconto</label>
                <select id="filter-type" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-pink-500 focus:ring-pink-500">
                    <option value="">Todos os Tipos</option>
                    <option value="percentage">Percentual (%)</option>
                    <option value="fixed">Valor Fixo (R$)</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Tabela de Cupons (Lista Principal) -->
    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Código</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Desconto</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Uso Máximo</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Validade</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                    </tr>
                </thead>
                <tbody id="coupons-table-body" class="bg-white divide-y divide-gray-200">
                    <!-- Linhas de cupom serão preenchidas via JavaScript ou backend -->
                </tbody>
            </table>
        </div>
        
        <!-- Mensagem de Tabela Vazia -->
        <div id="empty-state" class="p-6 text-center text-gray-500 hidden">
            Nenhum cupom encontrado. Crie o primeiro cupom de marketing agora!
        </div>
    </div>
</div>

<!-- Modal para Adicionar/Editar Cupom (Estrutura Flutuante) -->
<div id="coupon-modal" class="fixed inset-0 z-50 overflow-y-auto bg-gray-900 bg-opacity-50 hidden" style="backdrop-filter: blur(2px);">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg transform transition-all duration-300 scale-95 opacity-0" id="modal-panel">
            <!-- Conteúdo do Modal -->
            <div class="p-6">
                <div class="flex justify-between items-center border-b pb-4 mb-4">
                    <h3 class="text-xl font-bold text-gray-800" id="modal-title">Adicionar Novo Cupom</h3>
                    <button id="close-modal-button" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times h-6 w-6"></i>
                    </button>
                </div>
                
                <form id="coupon-form">
                    
                    <!-- Campo Código -->
                    <div class="mb-4">
                        <label for="coupon-code" class="block text-sm font-medium text-gray-700">Código do Cupom</label>
                        <input type="text" id="coupon-code" required placeholder="EXEMPLO10"
                               class="mt-1 w-full border-gray-300 rounded-lg shadow-sm uppercase focus:border-pink-500 focus:ring-pink-500">
                    </div>

                    <!-- Tipo e Valor do Desconto -->
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="discount-type" class="block text-sm font-medium text-gray-700">Tipo</label>
                            <select id="discount-type" required
                                    class="mt-1 w-full border-gray-300 rounded-lg shadow-sm focus:border-pink-500 focus:ring-pink-500">
                                <option value="percentage">Percentual (%)</option>
                                <option value="fixed">Valor Fixo (R$)</option>
                            </select>
                        </div>
                        <div>
                            <label for="discount-value" class="block text-sm font-medium text-gray-700">Valor</label>
                            <input type="number" id="discount-value" required min="1" placeholder="10 ou 50.00"
                                   class="mt-1 w-full border-gray-300 rounded-lg shadow-sm focus:border-pink-500 focus:ring-pink-500">
                        </div>
                    </div>
                    
                    <!-- Datas de Validade -->
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="start-date" class="block text-sm font-medium text-gray-700">Início da Validade</label>
                            <input type="date" id="start-date" required
                                   class="mt-1 w-full border-gray-300 rounded-lg shadow-sm focus:border-pink-500 focus:ring-pink-500">
                        </div>
                        <div>
                            <label for="end-date" class="block text-sm font-medium text-gray-700">Fim da Validade</label>
                            <input type="date" id="end-date" required
                                   class="mt-1 w-full border-gray-300 rounded-lg shadow-sm focus:border-pink-500 focus:ring-pink-500">
                        </div>
                    </div>

                    <!-- Limites de Uso -->
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div>
                            <label for="max-uses" class="block text-sm font-medium text-gray-700">Usos Máximos (Total)</label>
                            <input type="number" id="max-uses" min="1" value="100"
                                   class="mt-1 w-full border-gray-300 rounded-lg shadow-sm focus:border-pink-500 focus:ring-pink-500">
                        </div>
                        <div>
                            <label for="min-purchase" class="block text-sm font-medium text-gray-700">Valor Mínimo (R$)</label>
                            <input type="number" id="min-purchase" min="0" value="0.00"
                                   class="mt-1 w-full border-gray-300 rounded-lg shadow-sm focus:border-pink-500 focus:ring-pink-500">
                        </div>
                    </div>
                    
                    <!-- Botões do Formulário -->
                    <div class="flex justify-end space-x-3">
                        <button type="button" id="cancel-modal-button" class="px-4 py-2 text-gray-700 border border-gray-300 rounded-xl hover:bg-gray-50 transition duration-150">
                            Cancelar
                        </button>
                        <button type="submit" class="px-4 py-2 bg-pink-600 text-white font-semibold rounded-xl hover:bg-pink-700 transition duration-150">
                            Salvar Cupom
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmação para Exclusão -->
<div id="confirm-modal" class="fixed inset-0 z-50 overflow-y-auto bg-gray-900 bg-opacity-50 hidden" style="backdrop-filter: blur(2px);">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm transform transition-all duration-300 scale-95 opacity-0" id="confirm-modal-panel">
            <div class="p-6 text-center">
                <i class="fas fa-exclamation-triangle text-red-500 text-4xl mb-4"></i>
                <h3 class="text-lg font-bold text-gray-800 mb-2">Confirmar Exclusão</h3>
                <p class="text-sm text-gray-600 mb-6">Tem certeza que deseja remover o cupom <span id="coupon-to-delete-code" class="font-semibold text-pink-600"></span>? Esta ação não pode ser desfeita.</p>
                
                <div class="flex justify-center space-x-4">
                    <button type="button" id="cancel-delete-button" class="px-4 py-2 text-gray-700 border border-gray-300 rounded-xl hover:bg-gray-50 transition duration-150">
                        Cancelar
                    </button>
                    <button type="button" id="confirm-delete-button" data-coupon-id="" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-xl hover:bg-red-700 transition duration-150">
                        Sim, Excluir
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>


<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, doc, setDoc, deleteDoc, query, where, getDocs, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    setLogLevel('Debug');

    // Variáveis globais obrigatórias
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

    // Inicialização do Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let userId = null;
    let currentEditingCouponId = null;
    
    // --- Referências DOM ---
    const tableBody = document.getElementById('coupons-table-body');
    const emptyState = document.getElementById('empty-state');
    const couponModal = document.getElementById('coupon-modal');
    const modalPanel = document.getElementById('modal-panel');
    const confirmModal = document.getElementById('confirm-modal');
    const confirmModalPanel = document.getElementById('confirm-modal-panel');
    const couponForm = document.getElementById('coupon-form');
    const modalTitle = document.getElementById('modal-title');
    const confirmDeleteButton = document.getElementById('confirm-delete-button');

    // --- Funções Auxiliares ---

    /**
     * Autentica o usuário e inicializa a aplicação.
     */
    async function initializeAuth() {
        try {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
            userId = auth.currentUser?.uid || crypto.randomUUID();
            console.log('Autenticação Firebase concluída. User ID:', userId);
            setupRealtimeCouponsListener();
        } catch (error) {
            console.error('Erro na autenticação Firebase:', error);
        }
    }

    /**
     * Retorna a referência da coleção de cupons (privada para o admin).
     */
    function getCouponsCollectionRef() {
        return collection(db, `artifacts/${appId}/users/${userId}/coupons`);
    }

    /**
     * Abre o modal de Adição/Edição.
     * @param {Object} coupon - Dados do cupom para edição, ou null para adicionar.
     */
    function openCouponModal(coupon = null) {
        couponForm.reset();
        currentEditingCouponId = null;

        if (coupon) {
            currentEditingCouponId = coupon.id;
            modalTitle.textContent = 'Editar Cupom';
            document.getElementById('coupon-code').value = coupon.code;
            document.getElementById('discount-type').value = coupon.type;
            document.getElementById('discount-value').value = coupon.value;
            document.getElementById('start-date').value = coupon.startDate;
            document.getElementById('end-date').value = coupon.endDate;
            document.getElementById('max-uses').value = coupon.maxUses;
            document.getElementById('min-purchase').value = coupon.minPurchase;
        } else {
            modalTitle.textContent = 'Adicionar Novo Cupom';
            // Define valores padrão
            document.getElementById('discount-type').value = 'percentage';
            document.getElementById('discount-value').value = 10;
            document.getElementById('max-uses').value = 100;
            document.getElementById('min-purchase').value = 0.00;
            // Define a data de início para hoje
            document.getElementById('start-date').value = new Date().toISOString().split('T')[0];
        }

        couponModal.classList.remove('hidden');
        setTimeout(() => {
            modalPanel.classList.remove('scale-95', 'opacity-0');
            modalPanel.classList.add('scale-100', 'opacity-100');
        }, 10);
    }

    /**
     * Fecha o modal de Adição/Edição.
     */
    function closeCouponModal() {
        modalPanel.classList.remove('scale-100', 'opacity-100');
        modalPanel.classList.add('scale-95', 'opacity-0');
        setTimeout(() => {
            couponModal.classList.add('hidden');
        }, 300);
    }

    /**
     * Abre o modal de Confirmação de Exclusão.
     * @param {string} id - ID do cupom a ser excluído.
     * @param {string} code - Código do cupom.
     */
    function openConfirmModal(id, code) {
        document.getElementById('coupon-to-delete-code').textContent = code;
        confirmDeleteButton.dataset.couponId = id;
        
        confirmModal.classList.remove('hidden');
        setTimeout(() => {
            confirmModalPanel.classList.remove('scale-95', 'opacity-0');
            confirmModalPanel.classList.add('scale-100', 'opacity-100');
        }, 10);
    }

    /**
     * Fecha o modal de Confirmação de Exclusão.
     */
    function closeConfirmModal() {
        confirmModalPanel.classList.remove('scale-100', 'opacity-100');
        confirmModalPanel.classList.add('scale-95', 'opacity-0');
        setTimeout(() => {
            confirmModal.classList.add('hidden');
        }, 300);
    }

    /**
     * Salva ou atualiza um cupom no Firestore.
     * @param {Event} e - Evento de submit do formulário.
     */
    async function handleCouponSubmit(e) {
        e.preventDefault();

        const data = {
            code: document.getElementById('coupon-code').value.toUpperCase().trim(),
            type: document.getElementById('discount-type').value,
            value: parseFloat(document.getElementById('discount-value').value),
            startDate: document.getElementById('start-date').value,
            endDate: document.getElementById('end-date').value,
            maxUses: parseInt(document.getElementById('max-uses').value, 10) || 0,
            usedCount: 0, // Novo cupom sempre começa com 0 usos
            minPurchase: parseFloat(document.getElementById('min-purchase').value) || 0,
            createdAt: new Date().toISOString(),
        };

        try {
            const collectionRef = getCouponsCollectionRef();
            
            if (currentEditingCouponId) {
                // Editar cupom existente
                const couponDocRef = doc(collectionRef, currentEditingCouponId);
                // Evita sobrescrever o usedCount existente, a menos que seja um novo cupom
                await updateDoc(couponDocRef, data);
                console.log('Cupom atualizado com sucesso:', currentEditingCouponId);
            } else {
                // Adicionar novo cupom
                const newDocRef = doc(collectionRef);
                await setDoc(newDocRef, data);
                console.log('Novo cupom adicionado com sucesso:', newDocRef.id);
            }
            closeCouponModal();
        } catch (error) {
            console.error('Erro ao salvar o cupom:', error);
            // Em um app real, mostrar uma mensagem de erro para o usuário
        }
    }

    /**
     * Exclui um cupom do Firestore.
     * @param {string} couponId - ID do cupom a ser excluído.
     */
    async function deleteCoupon(couponId) {
        try {
            const docRef = doc(getCouponsCollectionRef(), couponId);
            await deleteDoc(docRef);
            console.log('Cupom excluído com sucesso:', couponId);
            closeConfirmModal();
        } catch (error) {
            console.error('Erro ao excluir o cupom:', error);
        }
    }

    /**
     * Renderiza uma linha na tabela para um cupom.
     * @param {Object} coupon - Dados do cupom.
     */
    function renderCouponRow(coupon) {
        const row = document.createElement('tr');
        row.id = `coupon-${coupon.id}`;
        
        // Determina o status
        const endDate = new Date(coupon.endDate);
        const today = new Date();
        today.setHours(0, 0, 0, 0); // Zera hora para comparação de data
        endDate.setHours(23, 59, 59, 999); // Final do dia

        let statusText = 'Ativo';
        let statusClasses = 'bg-green-100 text-green-800';
        let isActive = true;

        if (endDate < today) {
            statusText = 'Expirado';
            statusClasses = 'bg-red-100 text-red-800';
            isActive = false;
        } else if (coupon.maxUses > 0 && coupon.usedCount >= coupon.maxUses) {
             statusText = 'Esgotado';
             statusClasses = 'bg-yellow-100 text-yellow-800';
             isActive = false;
        } else if (coupon.startDate && new Date(coupon.startDate) > today) {
            statusText = 'Programado';
            statusClasses = 'bg-blue-100 text-blue-800';
            isActive = false;
        }
        
        // Formata o desconto
        let discountDisplay;
        if (coupon.type === 'percentage') {
            discountDisplay = `${coupon.value}% OFF`;
        } else {
            discountDisplay = `R$ ${coupon.value.toFixed(2).replace('.', ',')} OFF`;
        }

        // HTML da Linha
        row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${coupon.code}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-pink-600 font-semibold">${discountDisplay}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${coupon.usedCount}/${coupon.maxUses || 'Ilimitado'}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(coupon.endDate).toLocaleDateString('pt-BR')}</td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClasses}">
                    ${statusText}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                <button class="text-indigo-600 hover:text-indigo-900 edit-button" data-coupon-id="${coupon.id}">
                    <i class="fas fa-edit mr-1"></i> Editar
                </button>
                <button class="text-red-600 hover:text-red-900 delete-button" data-coupon-id="${coupon.id}" data-coupon-code="${coupon.code}">
                    <i class="fas fa-trash-alt mr-1"></i> Excluir
                </button>
            </td>
        `;

        // Adiciona listeners aos botões
        row.querySelector('.edit-button').addEventListener('click', () => openCouponModal(coupon));
        row.querySelector('.delete-button').addEventListener('click', (e) => {
            const id = e.currentTarget.dataset.couponId;
            const code = e.currentTarget.dataset.couponCode;
            openConfirmModal(id, code);
        });

        return row;
    }

    /**
     * Configura o listener em tempo real (onSnapshot) para os cupons.
     */
    function setupRealtimeCouponsListener() {
        if (!userId) {
            console.error('UserId não definido. Não é possível configurar o listener.');
            return;
        }

        const couponsQuery = query(getCouponsCollectionRef());

        onSnapshot(couponsQuery, (snapshot) => {
            let hasCoupons = false;
            
            snapshot.docChanges().forEach(change => {
                const coupon = { id: change.doc.id, ...change.doc.data() };
                const existingRow = document.getElementById(`coupon-${coupon.id}`);

                if (change.type === 'added' || change.type === 'modified') {
                    if (existingRow) {
                        existingRow.replaceWith(renderCouponRow(coupon));
                    } else {
                        tableBody.prepend(renderCouponRow(coupon));
                    }
                } else if (change.type === 'removed') {
                    if (existingRow) {
                        existingRow.remove();
                    }
                }
            });

            // Verifica o estado de vazio (Empty State)
            hasCoupons = tableBody.children.length > 0;
            emptyState.classList.toggle('hidden', hasCoupons);
        }, (error) => {
            console.error('Erro ao receber atualização de cupons:', error);
        });
    }

    // --- Configuração de Event Listeners ---
    
    // Botão Adicionar
    document.getElementById('open-modal-button').addEventListener('click', () => openCouponModal());

    // Botões Cancelar/Fechar Modal
    document.getElementById('close-modal-button').addEventListener('click', closeCouponModal);
    document.getElementById('cancel-modal-button').addEventListener('click', closeCouponModal);
    document.getElementById('cancel-delete-button').addEventListener('click', closeConfirmModal);
    
    // Fechar modal ao clicar fora
    couponModal.addEventListener('click', (e) => {
        if (e.target === couponModal) closeCouponModal();
    });
    confirmModal.addEventListener('click', (e) => {
        if (e.target === confirmModal) closeConfirmModal();
    });

    // Submissão do Formulário de Cupom
    couponForm.addEventListener('submit', handleCouponSubmit);

    // Confirmação de Exclusão
    confirmDeleteButton.addEventListener('click', (e) => {
        const couponId = e.currentTarget.dataset.couponId;
        if (couponId) {
            deleteCoupon(couponId);
        }
    });

    // --- Inicialização ---
    initializeAuth();

    // Nota: Filtros de busca (search-code, filter-status, filter-type)
    // A lógica de filtragem em tempo real usando query.where() com onSnapshot seria mais complexa,
    // pois o Firestore não suporta consultas com 'LIKE' ou múltiplas cláusulas 'where' em campos diferentes.
    // Para simplificar e manter a reatividade, a busca e filtros serão deixados para serem implementados
    // no lado do cliente (filtrando a lista de 'coupons' em JavaScript) em um passo futuro, se necessário.
    
</script>

{% endblock %}

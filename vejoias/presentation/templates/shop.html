<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loja | Vejoias</title>
    <!-- Carregamento do Tailwind CSS para estilo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configuração da fonte Inter -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
    </style>
    <!-- Ícones Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Header com Navegação e Link Admin -->
    <header class="bg-white shadow-lg sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <!-- Logo/Título -->
            <a href="./home.html" class="text-3xl font-extrabold text-pink-600 tracking-wider">Vejoias</a>
            
            <!-- Navegação e Ações -->
            <nav class="flex items-center space-x-6">
                <a href="./admin.html" class="text-sm font-medium text-gray-500 hover:text-pink-600 transition flex items-center p-2 rounded-full bg-gray-100 hover:bg-pink-100">
                    <i class="fas fa-user-shield text-lg mr-1"></i> Admin
                </a>

                <a href="./shop.html" class="text-lg font-bold text-pink-600 transition hidden sm:inline border-b-2 border-pink-600">Loja</a>
                <a href="./auth.html" id="auth-link" class="text-lg font-medium text-gray-700 hover:text-pink-600 transition hidden sm:inline">Login</a>

                <!-- Carrinho -->
                <a href="./cart.html" id="cart-button" class="relative text-gray-700 hover:text-pink-600 transition">
                    <i class="fas fa-shopping-cart text-xl"></i>
                    <span id="cart-count" class="absolute -top-2 -right-2 bg-pink-600 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center">0</span>
                </a>
            </nav>
        </div>
    </header>

    <main class="min-h-[85vh]">

        <!-- Banner Simples -->
        <div class="bg-pink-50 py-12 text-center">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-pink-800 mb-2">Explore Nossa Coleção</h1>
            <p class="text-lg text-pink-600">Encontre a joia perfeita para cada ocasião.</p>
        </div>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12 flex flex-col lg:flex-row gap-8">
            
            <!-- Coluna de Filtros (Lateral Esquerda no Desktop) -->
            <aside class="lg:w-1/4 bg-white p-6 rounded-xl shadow-lg h-fit sticky top-20">
                <h2 class="text-xl font-bold text-gray-900 mb-4 border-b pb-2 flex items-center">
                    <i class="fas fa-filter mr-2 text-pink-500"></i> Filtrar
                </h2>
                
                <!-- Filtro por Categoria -->
                <div class="mb-6">
                    <label for="category-filter" class="block text-lg font-semibold text-gray-700 mb-2">Categoria</label>
                    <select id="category-filter" class="block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:border-pink-500 focus:ring-pink-500 bg-white">
                        <option value="all">Todas as Joias</option>
                        <option value="Aneis">Anéis</option>
                        <option value="Colares">Colares</option>
                        <option value="Brincos">Brincos</option>
                        <option value="Pulseiras">Pulseiras</option>
                    </select>
                </div>
                
                <!-- Botão de Reset -->
                <button id="reset-filters-btn" class="w-full py-3 bg-gray-200 text-gray-700 font-bold rounded-lg shadow-md hover:bg-gray-300 transition">
                    <i class="fas fa-redo mr-2"></i> Limpar Filtros
                </button>
            </aside>
            
            <!-- Coluna de Produtos (Direita) -->
            <section class="lg:w-3/4">
                <div id="products-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
                    <!-- Produtos serão carregados aqui -->
                    <p id="loading-message" class="col-span-full text-center text-gray-500 py-10">
                        <i class="fas fa-spinner fa-spin mr-2"></i> Carregando produtos...
                    </p>
                    <p id="no-products-message" class="col-span-full text-center text-gray-500 py-10 hidden">
                        Nenhum produto encontrado para o filtro selecionado.
                    </p>
                </div>
            </section>
        </div>

    </main>

    <!-- Modal de Mensagem Temporária (Substitui alert) -->
    <div id="temp-message-div" class="fixed top-4 right-4 z-50 p-4 rounded-lg shadow-xl text-white transform translate-y-[-100px] transition-transform duration-300 hidden"></div>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white mt-12 py-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <p class="text-pink-400 font-semibold mb-2">Vejoias &copy; 2024</p>
            <div class="flex justify-center space-x-6 text-gray-400">
                <a href="./home.html" class="hover:text-white transition">Home</a>
                <a href="./shop.html" class="hover:text-pink-400 transition">Loja</a>
                <a href="./cart.html" class="hover:text-white transition">Carrinho</a>
                <a href="./admin.html" class="hover:text-pink-400 transition">Admin</a>
            </div>
        </div>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, onSnapshot, query, where, setLogLevel, doc, setDoc, getDoc 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('Debug');

        // Variáveis globais obrigatórias
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const ADMIN_UID = 'default-admin-uid';
        
        // Inicialização do Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let currentUserId = null;
        let allProducts = []; // Armazena todos os produtos ativos
        let currentFilter = 'all'; // Estado do filtro

        // --- Referências DOM ---
        const cartCountSpan = document.getElementById('cart-count');
        const productsListContainer = document.getElementById('products-list');
        const loadingMessage = document.getElementById('loading-message');
        const noProductsMessage = document.getElementById('no-products-message');
        const authLink = document.getElementById('auth-link');
        const categoryFilterSelect = document.getElementById('category-filter');
        const resetFiltersBtn = document.getElementById('reset-filters-btn');

        // --- Funções Auxiliares ---
        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        }
        
        /**
         * Retorna a referência da coleção de produtos do Admin.
         */
        function getProductsCollectionRef() {
            // Caminho: /artifacts/{appId}/users/{ADMIN_UID}/products
            return collection(db, `artifacts/${appId}/users/${ADMIN_UID}/products`);
        }
        
        /**
         * Retorna a referência do carrinho do usuário.
         */
        function getCartDocRef(userId) {
            // Caminho: /artifacts/{appId}/users/{userId}/cart/current
            return doc(db, `artifacts/${appId}/users/${userId}/cart/current`);
        }

        /**
         * Cria o HTML para um cartão de produto.
         */
        function createProductCard(product) {
            const isOutOfStock = product.stock <= 0;
            const stockText = isOutOfStock ? '<span class="text-red-500 font-semibold">Esgotado</span>' : `Estoque: ${product.stock}`;

            return `
                <div class="bg-white rounded-xl shadow-xl p-4 flex flex-col items-center text-center transition transform hover:scale-[1.02] hover:shadow-pink-300/50">
                    <img src="${product.imageUrl || 'https://placehold.co/200x200/f9a8d4/FFFFFF?text=Joia'}" 
                         alt="${product.name}" 
                         class="w-full h-48 object-cover rounded-lg mb-4"
                         onerror="this.onerror=null;this.src='https://placehold.co/200x200/f9a8d4/FFFFFF?text=Joia';">
                    
                    <h3 class="text-xl font-bold text-gray-900 mb-1">${product.name}</h3>
                    <p class="text-sm text-pink-600 mb-3">${product.category}</p>
                    
                    <p class="text-2xl font-extrabold text-green-600 mb-3">${formatCurrency(product.price)}</p>
                    
                    <p class="text-xs text-gray-500 mb-4">${stockText}</p>

                    <button data-id="${product.id}" 
                            data-name="${product.name}"
                            data-price="${product.price}"
                            data-image="${product.imageUrl || 'https://placehold.co/40x40/f9a8d4/FFFFFF?text=J'}"
                            class="add-to-cart-btn w-full py-2 ${isOutOfStock ? 'bg-gray-400 cursor-not-allowed' : 'bg-pink-600 hover:bg-pink-700'} text-white font-bold rounded-lg transition"
                            ${isOutOfStock ? 'disabled' : ''}>
                        <i class="fas fa-cart-plus mr-2"></i> 
                        ${isOutOfStock ? 'Sem Estoque' : 'Adicionar ao Carrinho'}
                    </button>
                </div>
            `;
        }
        
        /**
         * Renderiza os produtos filtrados.
         */
        function renderProducts() {
            loadingMessage.classList.add('hidden');
            
            // 1. Filtra os produtos com base no estado atual
            const filteredProducts = allProducts.filter(product => {
                if (currentFilter === 'all') {
                    return true;
                }
                return product.category === currentFilter;
            });

            productsListContainer.innerHTML = '';
            
            if (filteredProducts.length === 0) {
                noProductsMessage.classList.remove('hidden');
                return;
            }
            
            noProductsMessage.classList.add('hidden');
            
            // 2. Renderiza os produtos filtrados
            filteredProducts.forEach(product => {
                productsListContainer.innerHTML += createProductCard(product);
            });
            
            // 3. Adiciona listeners aos botões "Adicionar ao Carrinho"
            document.querySelectorAll('.add-to-cart-btn').forEach(button => {
                button.addEventListener('click', handleAddToCart);
            });
        }
        
        /**
         * Listener em tempo real para obter todos os produtos ativos.
         */
        function startProductsListener() {
            // Query para obter apenas produtos ativos (status: 'active')
            const productsQuery = query(getProductsCollectionRef(), where("status", "==", "active"));
            
            onSnapshot(productsQuery, (snapshot) => {
                allProducts = []; // Limpa o array global
                snapshot.forEach(doc => {
                    allProducts.push({ id: doc.id, ...doc.data() });
                });

                // Re-renderiza a lista (mantendo o filtro atual)
                renderProducts();

            }, (error) => {
                console.error("Erro ao carregar produtos:", error);
                loadingMessage.textContent = 'Erro ao carregar produtos. Verifique o console.';
            });
        }
        
        /**
         * Atualiza o contador de itens no carrinho.
         */
        function updateCartCount(cartData) {
            const totalItems = Object.values(cartData.items || {}).reduce((sum, item) => sum + item.quantity, 0);
            cartCountSpan.textContent = totalItems;
        }

        /**
         * Listener do Carrinho para manter o contador atualizado.
         */
        function startCartListener(userId) {
            onSnapshot(getCartDocRef(userId), (docSnapshot) => {
                if (docSnapshot.exists()) {
                    updateCartCount(docSnapshot.data());
                } else {
                    updateCartCount({ items: {} });
                }
            }, (error) => {
                console.error("Erro no listener do carrinho:", error);
            });
        }

        /**
         * Adiciona um item ao carrinho.
         */
        async function handleAddToCart(event) {
            if (!currentUserId) {
                showTemporaryMessage('Por favor, faça login para adicionar itens ao carrinho.', 'info');
                return;
            }

            const button = event.currentTarget;
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i>';

            const productId = button.dataset.id;
            const productName = button.dataset.name;
            const productPrice = parseFloat(button.dataset.price);
            const productImageUrl = button.dataset.image;

            const cartRef = getCartDocRef(currentUserId);

            try {
                const docSnap = await getDoc(cartRef);
                const cartData = docSnap.exists() ? docSnap.data() : { items: {} };
                const items = cartData.items || {};

                // Adiciona ou incrementa o item
                items[productId] = {
                    id: productId,
                    name: productName,
                    price: productPrice,
                    imageUrl: productImageUrl,
                    quantity: (items[productId]?.quantity || 0) + 1
                };

                await setDoc(cartRef, { items: items, lastUpdated: new Date().toISOString() });
                
                showTemporaryMessage('Item adicionado ao carrinho!', 'success');

            } catch (error) {
                console.error("Erro ao adicionar ao carrinho:", error);
                showTemporaryMessage('Falha ao adicionar ao carrinho.', 'error');
            } finally {
                // Re-renderiza para atualizar o botão, caso o estoque tenha mudado (embora isso seja melhor tratado no listener de produtos)
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-cart-plus mr-2"></i> Adicionar ao Carrinho';
            }
        }
        
        /**
         * Exibe uma mensagem temporária (substituindo o alert).
         */
        function showTemporaryMessage(message, type = 'info') {
            let messageDiv = document.getElementById('temp-message-div');
            messageDiv.classList.remove('hidden');

            let bgColor = type === 'success' ? 'bg-green-600' : (type === 'error' ? 'bg-red-600' : 'bg-blue-600');
            
            // Remove classes antigas e adiciona a nova cor e posição
            messageDiv.classList.remove('bg-green-600', 'bg-red-600', 'bg-blue-600');
            messageDiv.classList.add(bgColor);
            messageDiv.textContent = message;
            
            // Move para a posição visível
            messageDiv.style.transform = 'translateY(0)';

            setTimeout(() => {
                // Move para fora da tela
                messageDiv.style.transform = 'translateY(-100px)';
                // Oculta após a transição
                setTimeout(() => messageDiv.classList.add('hidden'), 300); 
            }, 3000);
        }

        // --- Eventos de Filtro ---
        categoryFilterSelect.addEventListener('change', (e) => {
            currentFilter = e.target.value;
            renderProducts();
        });

        resetFiltersBtn.addEventListener('click', () => {
            currentFilter = 'all';
            categoryFilterSelect.value = 'all';
            renderProducts();
        });


        // --- Inicialização ---
        window.onload = function() {
            // Tenta autenticar via token customizado ou anônimo
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                signInWithCustomToken(auth, __initial_auth_token).catch(e => {
                    console.error('Erro na autenticação com token customizado, caindo para anônimo:', e);
                    signInAnonymously(auth); 
                });
            } else {
                 signInAnonymously(auth).catch(e => {
                     console.error("Falha ao tentar login anônimo", e);
                 });
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUserId = user.uid;
                    authLink.textContent = 'Sair';
                    authLink.href = '#';
                    authLink.onclick = async () => {
                        await auth.signOut();
                        window.location.reload();
                    };
                    startCartListener(currentUserId);
                } else {
                    currentUserId = null;
                    authLink.textContent = 'Login';
                    authLink.href = './auth.html';
                    authLink.onclick = null;
                }
            });

            // Inicia o carregamento e exibição dos produtos (que aciona o renderProducts)
            startProductsListener();
        }
    </script>
</body>
</html>

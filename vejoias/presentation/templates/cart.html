<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carrinho | Vejoias</title>
    <!-- Carregamento do Tailwind CSS para estilo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configuração da fonte Inter -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
    </style>
    <!-- Ícones Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Header com Navegação e Link Admin -->
    <header class="bg-white shadow-lg sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <!-- Logo/Título -->
            <a href="./home.html" class="text-3xl font-extrabold text-pink-600 tracking-wider">Vejoias</a>
            
            <!-- Navegação e Ações -->
            <nav class="flex items-center space-x-6">
                <a href="./admin.html" class="text-sm font-medium text-gray-500 hover:text-pink-600 transition flex items-center p-2 rounded-full bg-gray-100 hover:bg-pink-100">
                    <i class="fas fa-user-shield text-lg mr-1"></i> Admin
                </a>

                <a href="./shop.html" class="text-lg font-medium text-gray-700 hover:text-pink-600 transition hidden sm:inline">Loja</a>
                <a href="./auth.html" id="auth-link" class="text-lg font-medium text-gray-700 hover:text-pink-600 transition hidden sm:inline">Login</a>

                <!-- Carrinho -->
                <a href="./cart.html" id="cart-button" class="relative text-pink-600 hover:text-pink-600 transition">
                    <i class="fas fa-shopping-cart text-xl"></i>
                    <span id="cart-count" class="absolute -top-2 -right-2 bg-pink-600 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center border-2 border-white">0</span>
                </a>
            </nav>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12 min-h-[80vh]">

        <h1 class="text-4xl font-extrabold text-gray-900 mb-8 border-b-4 border-pink-200 pb-3 flex items-center">
            <i class="fas fa-shopping-basket mr-3 text-pink-600"></i> Seu Carrinho
        </h1>
        
        <div id="cart-container" class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Coluna de Itens do Carrinho (2/3) -->
            <section class="lg:col-span-2 space-y-4">
                <div id="cart-items-list" class="bg-white rounded-xl shadow-lg p-6 min-h-[200px] flex flex-col justify-center items-center">
                    <!-- Itens serão renderizados aqui -->
                    <p id="loading-message" class="text-gray-500 py-10">
                        <i class="fas fa-spinner fa-spin mr-2"></i> Verificando carrinho...
                    </p>
                    <p id="empty-cart-message" class="text-gray-500 py-10 hidden text-center">
                        <i class="fas fa-box-open text-4xl mb-3 text-pink-300"></i><br>
                        Seu carrinho está vazio. <a href="./shop.html" class="text-pink-600 font-semibold hover:text-pink-800">Explore nossa loja!</a>
                    </p>
                    <p id="login-message" class="text-gray-600 py-10 hidden text-center">
                        <i class="fas fa-user-lock text-4xl mb-3 text-red-400"></i><br>
                        Faça <a href="./auth.html" class="text-pink-600 font-semibold hover:text-pink-800">login</a> ou se autentique para ver seu carrinho.
                    </p>
                </div>
            </section>

            <!-- Coluna de Resumo (1/3) -->
            <aside class="lg:col-span-1 h-fit sticky top-20">
                <div class="bg-white rounded-xl shadow-lg p-6 border-t-4 border-pink-500">
                    <h2 class="text-2xl font-bold text-gray-900 mb-4 border-b pb-2">Resumo da Compra</h2>
                    
                    <div class="space-y-2 mb-6">
                        <div class="flex justify-between text-gray-600">
                            <span>Subtotal:</span>
                            <span id="subtotal" class="font-medium">R$ 0,00</span>
                        </div>
                        <div class="flex justify-between text-gray-600">
                            <span>Frete:</span>
                            <span id="shipping-cost" class="font-medium">Grátis</span>
                        </div>
                        <div class="flex justify-between text-lg font-bold pt-4 border-t border-gray-200">
                            <span>Total (R$):</span>
                            <span id="total" class="text-pink-600 text-2xl">R$ 0,00</span>
                        </div>
                    </div>

                    <a id="checkout-btn" href="./checkout.html" class="w-full block text-center py-3 bg-pink-600 text-white text-lg font-bold rounded-lg shadow-xl hover:bg-pink-700 transition transform hover:scale-[1.01] disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                        <i class="fas fa-credit-card mr-2"></i> Finalizar Compra
                    </a>
                </div>
            </aside>

        </div>

    </main>
    
    <!-- Modal de Mensagem Temporária (Substitui alert) -->
    <div id="temp-message-div" class="fixed top-4 right-4 z-50 p-4 rounded-lg shadow-xl text-white transform translate-y-[-100px] transition-transform duration-300 hidden"></div>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white mt-12 py-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <p class="text-pink-400 font-semibold mb-2">Vejoias &copy; 2024</p>
            <div class="flex justify-center space-x-6 text-gray-400">
                <a href="./home.html" class="hover:text-white transition">Home</a>
                <a href="./shop.html" class="hover:text-white transition">Loja</a>
                <a href="./cart.html" class="hover:text-pink-400 transition">Carrinho</a>
                <a href="./admin.html" class="hover:text-pink-400 transition">Admin</a>
            </div>
        </div>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, onSnapshot, setLogLevel, doc, setDoc, getDoc, deleteField 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('Debug');

        // Variáveis globais obrigatórias
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        
        // Inicialização do Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let currentUserId = null;
        let cartData = { items: {} };

        // --- Referências DOM ---
        const cartCountSpan = document.getElementById('cart-count');
        const authLink = document.getElementById('auth-link');
        const cartItemsList = document.getElementById('cart-items-list');
        const loadingMessage = document.getElementById('loading-message');
        const emptyCartMessage = document.getElementById('empty-cart-message');
        const loginMessage = document.getElementById('login-message');
        const subtotalSpan = document.getElementById('subtotal');
        const totalSpan = document.getElementById('total');
        const checkoutBtn = document.getElementById('checkout-btn');

        // --- Funções Auxiliares ---
        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        }
        
        /**
         * Retorna a referência do carrinho do usuário.
         */
        function getCartDocRef(userId) {
            // Caminho: /artifacts/{appId}/users/{userId}/cart/current
            return doc(db, `artifacts/${appId}/users/${userId}/cart/current`);
        }

        /**
         * Cria o HTML para um item no carrinho.
         */
        function createCartItemRow(item) {
            const itemTotal = item.price * item.quantity;
            
            return `
                <div class="flex items-center p-4 bg-white rounded-lg shadow-sm border border-gray-100">
                    <!-- Imagem -->
                    <img src="${item.imageUrl}" 
                         alt="${item.name}" 
                         class="w-16 h-16 object-cover rounded-md mr-4"
                         onerror="this.onerror=null;this.src='https://placehold.co/64x64/f9a8d4/FFFFFF?text=J';">

                    <!-- Detalhes do Item -->
                    <div class="flex-grow">
                        <p class="font-bold text-gray-900">${item.name}</p>
                        <p class="text-sm text-pink-600">${formatCurrency(item.price)}</p>
                    </div>

                    <!-- Controle de Quantidade -->
                    <div class="flex items-center space-x-2 mx-4">
                        <button data-id="${item.id}" data-action="decrease" class="qty-btn bg-gray-200 text-gray-700 w-8 h-8 rounded-full hover:bg-gray-300 transition disabled:opacity-50" ${item.quantity <= 1 ? 'disabled' : ''}>
                            <i class="fas fa-minus"></i>
                        </button>
                        <span class="text-lg font-semibold w-6 text-center">${item.quantity}</span>
                        <button data-id="${item.id}" data-action="increase" class="qty-btn bg-gray-200 text-gray-700 w-8 h-8 rounded-full hover:bg-gray-300 transition">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>

                    <!-- Subtotal e Remover -->
                    <div class="flex flex-col items-end">
                        <p class="text-lg font-extrabold text-pink-600 mb-2">${formatCurrency(itemTotal)}</p>
                        <button data-id="${item.id}" data-action="remove" class="remove-btn text-red-500 hover:text-red-700 text-sm transition">
                            <i class="fas fa-trash-alt mr-1"></i> Remover
                        </button>
                    </div>
                </div>
            `;
        }

        /**
         * Renderiza o conteúdo do carrinho (itens e totais).
         */
        function renderCart(data) {
            cartData = data; // Atualiza o estado global
            const items = Object.values(data.items || {});
            
            cartItemsList.innerHTML = '';
            loadingMessage.classList.add('hidden');

            if (!currentUserId) {
                loginMessage.classList.remove('hidden');
                emptyCartMessage.classList.add('hidden');
                checkoutBtn.disabled = true;
                return;
            } else {
                loginMessage.classList.add('hidden');
            }

            if (items.length === 0) {
                emptyCartMessage.classList.remove('hidden');
                checkoutBtn.disabled = true;
                subtotalSpan.textContent = formatCurrency(0);
                totalSpan.textContent = formatCurrency(0);
                return;
            }
            
            emptyCartMessage.classList.add('hidden');
            checkoutBtn.disabled = false;

            let subtotal = 0;
            
            items.forEach(item => {
                cartItemsList.innerHTML += createCartItemRow(item);
                subtotal += item.price * item.quantity;
            });

            // Cálculos
            subtotalSpan.textContent = formatCurrency(subtotal);
            // Assumimos frete grátis por simplicidade, então Total = Subtotal
            totalSpan.textContent = formatCurrency(subtotal);
            
            // Adiciona listeners para os botões de controle de quantidade e remoção
            document.querySelectorAll('.qty-btn').forEach(btn => {
                btn.addEventListener('click', handleQuantityChange);
            });
            document.querySelectorAll('.remove-btn').forEach(btn => {
                btn.addEventListener('click', handleRemoveItem);
            });
        }
        
        /**
         * Modifica a quantidade de um item no Firestore.
         */
        async function handleQuantityChange(event) {
            if (!currentUserId) return;
            
            const button = event.currentTarget;
            const productId = button.dataset.id;
            const action = button.dataset.action;
            
            const item = cartData.items[productId];
            if (!item) return;

            let newQuantity = item.quantity;
            if (action === 'increase') {
                newQuantity += 1;
            } else if (action === 'decrease' && newQuantity > 1) {
                newQuantity -= 1;
            } else {
                return; // Não faz nada se tentar diminuir para 0
            }
            
            try {
                // Prepara a cópia dos itens do carrinho
                const newItems = { ...cartData.items };
                newItems[productId] = { ...item, quantity: newQuantity };

                const cartRef = getCartDocRef(currentUserId);
                
                // Salva o novo estado completo do carrinho
                await setDoc(cartRef, { items: newItems, lastUpdated: new Date().toISOString() });
                
            } catch (error) {
                console.error("Erro ao alterar quantidade:", error);
                showTemporaryMessage('Falha ao alterar a quantidade.', 'error');
            }
        }

        /**
         * Remove um item do carrinho no Firestore.
         */
        async function handleRemoveItem(event) {
            if (!currentUserId) return;

            const button = event.currentTarget;
            const productId = button.dataset.id;
            
            // Desabilita o botão para evitar cliques múltiplos
            button.disabled = true;

            try {
                const newItems = { ...cartData.items };
                
                // Remove o item da cópia
                delete newItems[productId];

                const cartRef = getCartDocRef(currentUserId);

                // Salva o novo estado completo do carrinho
                await setDoc(cartRef, { items: newItems, lastUpdated: new Date().toISOString() });
                
                showTemporaryMessage('Item removido do carrinho!', 'info');

            } catch (error) {
                console.error("Erro ao remover item:", error);
                showTemporaryMessage('Falha ao remover o item.', 'error');
            }
        }
        
        /**
         * Atualiza o contador de itens no carrinho no cabeçalho.
         */
        function updateCartCount(cartData) {
            const totalItems = Object.values(cartData.items || {}).reduce((sum, item) => sum + item.quantity, 0);
            cartCountSpan.textContent = totalItems;
        }

        /**
         * Listener do Carrinho para manter o conteúdo e o contador atualizados.
         */
        function startCartListener(userId) {
            const cartRef = getCartDocRef(userId);
            
            // Inicia o listener que chama renderCart a cada mudança
            onSnapshot(cartRef, (docSnapshot) => {
                if (docSnapshot.exists()) {
                    const data = docSnapshot.data();
                    renderCart(data);
                    updateCartCount(data);
                } else {
                    // O documento não existe (carrinho vazio)
                    renderCart({ items: {} });
                    updateCartCount({ items: {} });
                }
            }, (error) => {
                console.error("Erro no listener do carrinho:", error);
                loadingMessage.textContent = 'Erro ao carregar seu carrinho. Tente recarregar.';
            });
        }
        
        /**
         * Exibe uma mensagem temporária (substituindo o alert).
         */
        function showTemporaryMessage(message, type = 'info') {
            let messageDiv = document.getElementById('temp-message-div');
            messageDiv.classList.remove('hidden');

            let bgColor = type === 'success' ? 'bg-green-600' : (type === 'error' ? 'bg-red-600' : 'bg-blue-600');
            
            messageDiv.classList.remove('bg-green-600', 'bg-red-600', 'bg-blue-600');
            messageDiv.classList.add(bgColor);
            messageDiv.textContent = message;
            
            messageDiv.style.transform = 'translateY(0)';

            setTimeout(() => {
                messageDiv.style.transform = 'translateY(-100px)';
                setTimeout(() => messageDiv.classList.add('hidden'), 300); 
            }, 3000);
        }

        // --- Inicialização e Autenticação ---
        window.onload = function() {
            // Tenta autenticar via token customizado ou anônimo
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                signInWithCustomToken(auth, __initial_auth_token).catch(e => {
                    console.error('Erro na autenticação com token customizado, caindo para anônimo:', e);
                    signInAnonymously(auth); 
                });
            } else {
                 signInAnonymously(auth).catch(e => {
                     console.error("Falha ao tentar login anônimo", e);
                 });
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUserId = user.uid;
                    authLink.textContent = 'Sair';
                    authLink.href = '#';
                    authLink.onclick = async () => {
                        await auth.signOut();
                        window.location.reload();
                    };
                    startCartListener(currentUserId);
                } else {
                    currentUserId = null;
                    authLink.textContent = 'Login';
                    authLink.href = './auth.html';
                    authLink.onclick = null;
                    // Força a renderização da mensagem de login se não houver usuário
                    renderCart({ items: {} });
                    updateCartCount({ items: {} }); 
                }
            });
        }
    </script>
</body>
</html>
